name: Orchestrate Issues & PRs (Unified)

on:
  issues:
    types: [opened, edited, labeled, reopened]
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review, edited, review_requested, closed]
  pull_request_review:
    types: [submitted]
  pull_request_review_comment:
    types: [created, edited]
  issue_comment:
    types: [created, edited]

permissions:
  contents: read
  pull-requests: write
  issues: write

concurrency:
  group: orchestrate-${{ github.event.pull_request.number || github.event.issue.number || github.sha }}
  cancel-in-progress: true

env:
  DRY_RUN_RESPONSES: "false" # set to "false" to enable posting

jobs:
  detect-and-route:
    name: Detect event type and set variables
    runs-on: ubuntu-latest
    # Note: Linter warnings about step outputs are expected and benign
    # All outputs are set by the detect step with fallback values
    outputs:
      is_issue: ${{ steps.detect.outputs.is_issue || 'false' }}
      is_pr: ${{ steps.detect.outputs.is_pr || 'false' }}
      is_review_comment: ${{ steps.detect.outputs.is_review_comment || 'false' }}
      is_pr_closed: ${{ steps.detect.outputs.is_pr_closed || 'false' }}
      is_pr_merged: ${{ steps.detect.outputs.is_pr_merged || 'false' }}
      issue_number: ${{ steps.detect.outputs.issue_number || '' }}
      pr_number: ${{ steps.detect.outputs.pr_number || '' }}
      review_state: ${{ steps.detect.outputs.review_state || '' }}
      review_comment_id: ${{ steps.detect.outputs.review_comment_id || '' }}
    steps:
      - id: detect
        uses: actions/github-script@v7
        with:
          script: |
            const payload = context.payload
            // issue_comment fires for both Issues and PRs (PRs are exposed as `payload.issue` with `issue.pull_request`).
            const isIssue = !!payload.issue && !payload.issue.pull_request && !payload.pull_request
            const isPR = !!payload.pull_request || (!!payload.issue && !!payload.issue.pull_request)
            const isReviewComment = !!payload.comment && !!payload.pull_request && payload.comment.pull_request_review_id != null
            const isPRClosed = context.eventName === 'pull_request' && payload.action === 'closed'
            const isPRMerged = isPRClosed && payload.pull_request.merged === true
            core.setOutput('is_issue', String(isIssue))
            core.setOutput('is_pr', String(isPR))
            core.setOutput('is_review_comment', String(isReviewComment))
            core.setOutput('is_pr_closed', String(isPRClosed))
            core.setOutput('is_pr_merged', String(isPRMerged))
            core.setOutput('issue_number', isIssue ? String(payload.issue.number) : '')
            // For issue_comment on a PR, the PR number is the issue.number.
            core.setOutput('pr_number', payload.pull_request ? String(payload.pull_request.number) : (payload.issue && payload.issue.pull_request ? String(payload.issue.number) : ''))
            core.setOutput('review_state', payload.review ? String(payload.review.state || '') : '')
            core.setOutput('review_comment_id', payload.comment ? String(payload.comment.id || '') : '')

  issue-orchestration:
    name: Issue orchestration
    needs: detect-and-route
    if: ${{ needs.detect-and-route.outputs.is_issue == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # GitHub CLI is preinstalled on ubuntu-latest

      - name: Auto-configure issue fields and labels
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ./scripts/issue-management/configure-issues-unified.ps1 -IssueNumber ${{ needs.detect-and-route.outputs.issue_number }} -Preset blog -AddToProject

      - name: Assign default owner and comment analysis start
        run: |
          gh issue edit ${{ needs.detect-and-route.outputs.issue_number }} --add-assignee jschibelli
          gh issue comment ${{ needs.detect-and-route.outputs.issue_number }} --body "Automated triage complete. Beginning analysis and drafting PR."

      - name: Create branch and draft PR from issue
        id: create-pr
        shell: bash
        env:
          ISSUE: ${{ needs.detect-and-route.outputs.issue_number }}
        run: |
          set -euo pipefail
          BRANCH="issue/${ISSUE}"
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git fetch origin
          git checkout -B "$BRANCH" origin/develop || git checkout -b "$BRANCH"
          git push -u origin "$BRANCH"
          TITLE=$(gh issue view "$ISSUE" --json title -q .title)
          BODY="Automated PR for Issue #${ISSUE}. This PR is created as draft and will be updated as work progresses.\n\nResolves #${ISSUE}"
          PR_NUM=$(gh pr create --title "$TITLE" --body "$BODY" --base develop --head "$BRANCH" --draft -q number)
          echo "pr_number=$PR_NUM" >> $GITHUB_OUTPUT

      - name: Configure PR in project and set Status
        if: steps.create-pr.outputs.pr_number != ''
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ steps.create-pr.outputs.pr_number }}
        run: |
          ./scripts/pr-management/configure-pr-auto.ps1 -PRNumber $env:PR_NUMBER -Status "In progress" -Priority "P1" -Size "M" -Estimate 3 -App "Portfolio Site" -Area "Frontend" -Assign "jschibelli"

      - name: Analyze created PR (CR-GPT) and upload report
        if: steps.create-pr.outputs.pr_number != ''
        run: |
          pwsh -c "./scripts/pr-management/pr-analyzer.ps1 -PRNumber ${{ steps.create-pr.outputs.pr_number }} -Analysis comprehensive -ExportTo analysis.md" || true
        continue-on-error: true

      - name: Upload analysis artifacts (issue path)
        if: steps.create-pr.outputs.pr_number != ''
        uses: actions/upload-artifact@v4
        with:
          name: issue-orchestrator-reports-${{ steps.create-pr.outputs.pr_number }}
          path: |
            analysis.md
          if-no-files-found: ignore

  pr-orchestration:
    name: PR orchestration
    needs: detect-and-route
    # Avoid running on issue_comment events (they can be on PRs too).
    if: ${{ needs.detect-and-route.outputs.is_pr == 'true' && needs.detect-and-route.outputs.is_pr_closed != 'true' && github.event_name != 'issue_comment' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Ensure base branch is develop (guard)
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request
            if (!pr) return
            if (pr.base.ref !== 'develop') {
              core.setFailed(`PR base must be 'develop'. Found '${pr.base.ref}'.`)
            }

      - name: Configure PR fields and assign
        if: success()
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ needs.detect-and-route.outputs.pr_number }}
        run: |
          ./scripts/pr-management/configure-pr-auto.ps1 -PRNumber $env:PR_NUMBER -Status "In progress" -Priority "P1" -Size "M" -Estimate 3 -App "Portfolio Site" -Area "Frontend" -Assign "jschibelli"

      - name: Setup Node + pnpm
        if: success()
        uses: ./.github/actions/setup-node-pnpm
        with:
          node-version: "20"
          pnpm-version: "10.14.0"

      - name: Run checks (build, lint, typecheck, tests)
        if: success()
        run: |
          pnpm run build || true
          pnpm run lint || true
          pnpm run typecheck || pnpm run type-check || true
          pnpm run test || true

      - name: PR analysis (report)
        if: success()
        run: |
          pwsh -c "./scripts/pr-management/pr-analyzer.ps1 -PRNumber ${{ needs.detect-and-route.outputs.pr_number }} -Analysis comprehensive -ExportTo analysis.md" || true
        continue-on-error: true

      - name: Universal PR Automation (CR-GPT monitoring, merge guidance)
        if: success()
        run: |
          pwsh -c "./scripts/pr-management/automate-pr-unified.ps1 -PRNumber ${{ needs.detect-and-route.outputs.pr_number }} -Action all"
        continue-on-error: true

      - name: Code Quality Checker
        if: success() && hashFiles('scripts/code-quality/check-code-quality.ps1') != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: pwsh -c "./scripts/code-quality/check-code-quality.ps1 -PRNumber ${{ needs.detect-and-route.outputs.pr_number }} -FixIssues -RunTests -GenerateReport"
        continue-on-error: true

      - name: Docs Updater
        if: success() && hashFiles('scripts/core-utilities/docs-updater.ps1') != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: pwsh -c "./scripts/core-utilities/docs-updater.ps1 -PRNumber ${{ needs.detect-and-route.outputs.pr_number }} -UpdateChangelog -UpdateReadme -GenerateDocs"
        continue-on-error: true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: orchestrator-reports-${{ needs.detect-and-route.outputs.pr_number }}
          path: |
            analysis.md
            quality-report-pr-*.md
            docs/generated/**
          if-no-files-found: ignore

      - name: Post Summary
        if: always() && needs.detect-and-route.outputs.pr_number != ''
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = Number('${{ needs.detect-and-route.outputs.pr_number }}' || '0')
            if (!prNumber) return
            const body = [
              '### PR Automation Summary',
              '- PR analysis, automation, and optional quality/docs steps executed.',
              '- Artifacts: `analysis.md`, `quality-report-pr-*.md`, `docs/generated/*` (if present).',
              `- DRY_RUN_RESPONSES = ${process.env.DRY_RUN_RESPONSES}`
            ].join('\n')
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body
            })

      - name: Optional auto-respond to CR-GPT thread (dry-run controlled)
        if: success()
        run: |
          if [ "${DRY_RUN_RESPONSES}" = "false" ]; then pwsh -c "./scripts/pr-management/automate-pr-unified.ps1 -PRNumber ${{ needs.detect-and-route.outputs.pr_number }} -Action respond"; else echo "Dry run: skipping responses"; fi

      - name: Update project Status to In review if reviews submitted
        if: github.event_name == 'pull_request_review' && success() && needs.detect-and-route.outputs.review_state != ''
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ needs.detect-and-route.outputs.pr_number }}
          REVIEW_STATE: ${{ needs.detect-and-route.outputs.review_state }}
        run: |
          $state = $env:REVIEW_STATE.ToUpperInvariant()
          if ($state -eq 'APPROVED' -or $state -eq 'CHANGES_REQUESTED' -or $state -eq 'COMMENTED' -or $state -eq 'SUBMITTED') {
            ./scripts/pr-management/configure-pr-auto.ps1 -PRNumber $env:PR_NUMBER -Status "In review" -Priority "P1" -Size "M" -Estimate 3 -App "Portfolio Site" -Area "Frontend" -Assign "jschibelli"
          } else {
            Write-Host "Review state '$($env:REVIEW_STATE)' not triggering status update"
          }

      - name: Gate auto-merge (approvals + checks + label)
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request
            const prNumber = pr ? pr.number : Number(process.env.PR_NUMBER)
            if (!prNumber) { core.notice('No PR number to gate merge'); return }
            const { data: reviews } = await github.rest.pulls.listReviews({ owner: context.repo.owner, repo: context.repo.repo, pull_number: prNumber })
            const approved = reviews.some(r => r.state === 'APPROVED')
            const { data: prInfo } = await github.rest.pulls.get({ owner: context.repo.owner, repo: context.repo.repo, pull_number: prNumber })
            const ciOk = prInfo.mergeable_state !== 'blocked'
            const { data: labels } = await github.rest.issues.listLabelsOnIssue({ owner: context.repo.owner, repo: context.repo.repo, issue_number: prNumber })
            const ready = labels.some(l => l.name === 'ready-to-merge')
            if (approved && ciOk && ready) {
              core.notice('All gates satisfied; enabling auto-merge (squash).')
              try {
                await github.graphql(`mutation($pr: ID!) { enablePullRequestAutoMerge(input: { pullRequestId: $pr, mergeMethod: SQUASH }) { pullRequest { number } } }`, { pr: context.payload.pull_request.node_id })
              } catch (e) {
                core.warning('Failed to enable auto-merge: ' + e.message)
              }
            } else {
              core.notice(`Gates not met. approved=${approved} ciOk=${ciOk} readyLabel=${ready}`)
            }

  review-comment-crgpt:
    name: Respond to CR-GPT review comments (threaded)
    needs: detect-and-route
    if: ${{ needs.detect-and-route.outputs.is_review_comment == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Resolve comment author and PR
        id: meta
        uses: actions/github-script@v7
        env:
          PR_NUMBER_IN: ${{ needs.detect-and-route.outputs.pr_number }}
          REVIEW_COMMENT_ID_IN: ${{ needs.detect-and-route.outputs.review_comment_id }}
        with:
          script: |
            const prNumber = Number(process.env.PR_NUMBER_IN || '0')
            const commentId = Number(process.env.REVIEW_COMMENT_ID_IN || '0')
            const author = context.payload.comment?.user?.login || ''
            // Always set all outputs to ensure they exist
            core.setOutput('pr', String(prNumber))
            core.setOutput('comment_id', String(commentId))
            core.setOutput('author', author)

      # Note: Linter warnings about steps.meta.outputs are expected
      # The meta step always runs and sets all outputs with defaults
      - name: Post threaded reply (CR-GPT only, dry-run)
        if: ${{ (steps.meta.outputs.author || '') == 'cr-gpt[bot]' && env.DRY_RUN_RESPONSES == 'true' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ steps.meta.outputs.pr || '' }}
          COMMENT_ID: ${{ steps.meta.outputs.comment_id || '' }}
        run: pwsh -c "./scripts/pr-management/automate-pr-unified.ps1 -PRNumber $env:PR_NUMBER -Action respond -DryRun"

      - name: Post threaded reply (CR-GPT only)
        if: ${{ (steps.meta.outputs.author || '') == 'cr-gpt[bot]' && env.DRY_RUN_RESPONSES != 'true' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ steps.meta.outputs.pr || '' }}
          COMMENT_ID: ${{ steps.meta.outputs.comment_id || '' }}
        run: pwsh -c "./scripts/pr-management/automate-pr-unified.ps1 -PRNumber $env:PR_NUMBER -Action respond"

  review-comment-triage:
    name: Review comment triage (labels)
    needs: detect-and-route
    if: ${{ needs.detect-and-route.outputs.is_review_comment == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup tools
        run: |
          sudo apt-get update
          sudo apt-get install -y gh jq
      - name: Label based on keywords
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          gh auth status || gh auth login --with-token <<< "$GITHUB_TOKEN"

          PR='${{ needs.detect-and-route.outputs.pr_number }}'
          BODY='${{ github.event.comment.body }}'
          LOWER=$(printf "%s" "$BODY" | tr '[:upper:]' '[:lower:]')

          if echo "$LOWER" | grep -q "bug\|null\|undefined\|exception"; then
            gh pr edit "$PR" --add-label "type: bug" || true
          fi
          if echo "$LOWER" | grep -q "perf\|performance\|optimiz"; then
            gh pr edit "$PR" --add-label "area: performance" || true
          fi

  issue-comment-commands:
    name: Issue comment commands router
    needs: detect-and-route
    if: ${{ github.event_name == 'issue_comment' && needs.detect-and-route.outputs.is_issue == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup tools
        run: |
          sudo apt-get update
          sudo apt-get install -y gh jq
      - name: Handle commands
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          gh auth status || gh auth login --with-token <<< "$GITHUB_TOKEN"

          BODY='${{ github.event.comment.body }}'
          ISSUE_NUMBER='${{ needs.detect-and-route.outputs.issue_number }}'
          ACTOR='${{ github.actor }}'

          echo "Comment on #$ISSUE_NUMBER by $ACTOR: $BODY"

          LOWER=$(printf "%s" "$BODY" | tr '[:upper:]' '[:lower:]')

          if echo "$LOWER" | grep -q "^/help"; then
            gh issue comment "$ISSUE_NUMBER" --body "Available commands:\n- /assign me\n- /status <ready|in progress|in review|done>\n- /priority <p0|p1|p2>\n- /labels add <comma,separated>\n- /unassign me"
            exit 0
          fi

          if echo "$LOWER" | grep -q "^/assign me$"; then
            gh issue edit "$ISSUE_NUMBER" --add-assignee "$ACTOR"
            exit 0
          fi

          if echo "$LOWER" | grep -q "^/unassign me$"; then
            gh issue edit "$ISSUE_NUMBER" --remove-assignee "$ACTOR"
            exit 0
          fi

          if echo "$LOWER" | grep -q "^/labels add "; then
            LABELS=$(printf "%s" "$BODY" | sed -E 's#^/labels add ##i')
            IFS=',' read -ra LA <<< "$LABELS"
            for l in "${LA[@]}"; do
              gh issue edit "$ISSUE_NUMBER" --add-label "$(echo "$l" | xargs)"
            done
            exit 0
          fi

          update_field() {
            ISSUE_ID=$(gh issue view "$ISSUE_NUMBER" --json id -q .id)
            ITEM_ID=$(gh api graphql -f query='query($issueId: ID!) { node(id: $issueId) { ... on Issue { projectItems(first: 10) { nodes { id project { id } } } } } }' -f issueId="$ISSUE_ID" | jq -r '.data.node.projectItems.nodes[0].id')
            [ -z "$ITEM_ID" ] && echo "No project item found" && exit 0
            gh api graphql -f query='mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $value: String!) { updateProjectV2ItemFieldValue(input: {projectId: $projectId, itemId: $itemId, fieldId: $fieldId, value: {singleSelectOptionId: $value}}) { projectV2Item { id } } }' \
              -f projectId=PVT_kwHOAEnMVc4BCu-c -f itemId="$ITEM_ID" -f fieldId="$1" -f value="$2" >/dev/null
          }

          STATUS_FIELD=PVTSSF_lAHOAEnMVc4BCu-czg028oM
          STATUS_READY=e18bf179
          STATUS_INPROGRESS=47fc9ee4
          STATUS_INREVIEW=aba860b9
          STATUS_DONE=98236657

          PRIORITY_FIELD=PVTSSF_lAHOAEnMVc4BCu-czg028qQ
          PRIORITY_P0=79628723
          PRIORITY_P1=0a877460
          PRIORITY_P2=da944a9c

          if echo "$LOWER" | grep -q "^/status "; then
            VAL=$(printf "%s" "$LOWER" | sed -E 's#^/status ##')
            case "$VAL" in
              ready)         update_field "$STATUS_FIELD" "$STATUS_READY" ;;
              "in progress") update_field "$STATUS_FIELD" "$STATUS_INPROGRESS" ;;
              "in review")   update_field "$STATUS_FIELD" "$STATUS_INREVIEW" ;;
              done)          update_field "$STATUS_FIELD" "$STATUS_DONE" ;;
              *) echo "Unknown status: $VAL" ;;
            esac
            exit 0
          fi

          if echo "$LOWER" | grep -q "^/priority "; then
            VAL=$(printf "%s" "$LOWER" | sed -E 's#^/priority ##')
            case "$VAL" in
              p0) update_field "$PRIORITY_FIELD" "$PRIORITY_P0" ;;
              p1) update_field "$PRIORITY_FIELD" "$PRIORITY_P1" ;;
              p2) update_field "$PRIORITY_FIELD" "$PRIORITY_P2" ;;
              *) echo "Unknown priority: $VAL" ;;
            esac
            exit 0
          fi

          echo "No matching command"

  pr-merged-status:
    name: Update Status on merge (Done)
    needs: detect-and-route
    if: ${{ needs.detect-and-route.outputs.is_pr_merged == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set Status=Done in project
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ needs.detect-and-route.outputs.pr_number }}
        run: |
          ./scripts/pr-management/configure-pr-auto.ps1 -PRNumber $env:PR_NUMBER -Status "Done" -Priority "P1" -Size "M" -Estimate 3 -App "Portfolio Site" -Area "Frontend" -Assign "jschibelli"


