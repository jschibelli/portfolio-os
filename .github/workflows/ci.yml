name: CI

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    paths:
      - 'apps/site/**'
      - 'apps/dashboard/**'
      - 'packages/**'
      - '.github/workflows/**'
  push:
    branches: [ develop ]
    paths:
      - 'apps/site/**'
      - 'apps/dashboard/**'
      - 'packages/**'
      - '.github/workflows/**'

# Cancel in-progress runs for same PR/branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    # Set timeout to prevent hung jobs
    timeout-minutes: 30
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Detect changed areas
        id: filter
        uses: dorny/paths-filter@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          filters: |
            site:
              - 'apps/site/**'
            dashboard:
              - 'apps/dashboard/**'
            packages:
              - 'packages/**'

      - name: Setup Node + pnpm
        uses: ./.github/actions/setup-node-pnpm
        with:
          node-version: "20"
          pnpm-version: "10.14.0"

      # Security: Audit dependencies for vulnerabilities
      - name: Security audit
        continue-on-error: true
        run: |
          echo "ðŸ”’ Running security audit..."
          echo "Checking for high and critical vulnerabilities..."
          if ! pnpm audit --audit-level=high; then
            echo "âš ï¸  Security vulnerabilities detected:"
            echo "   - High or critical vulnerabilities found in dependencies"
            echo "   - Review: Run 'pnpm audit' locally for detailed information"
            echo "   - Action: Update vulnerable packages or add exceptions"
            echo "   - Status: Non-blocking, but should be addressed before production"
          else
            echo "âœ… No high or critical vulnerabilities found"
          fi

      # Install dependencies with frozen lockfile for consistency
      - name: Explain change detection
        run: |
          echo "Changed areas:"
          echo "  - site: ${{ steps.filter.outputs.site }}"
          echo "  - dashboard: ${{ steps.filter.outputs.dashboard }}"
          echo "  - packages: ${{ steps.filter.outputs.packages }}"

      # Lint with improved error reporting
      - name: Lint applications
        id: lint
        continue-on-error: true
        run: |
          if [ "${{ steps.filter.outputs.site }}" != "true" ] && [ "${{ steps.filter.outputs.dashboard }}" != "true" ] && [ "${{ steps.filter.outputs.packages }}" != "true" ]; then
            echo "No relevant changes detected for lint; skipping."
            exit 0
          fi

          echo "ðŸ” Linting site application..."
          if [ "${{ steps.filter.outputs.site }}" = "true" ] || [ "${{ steps.filter.outputs.packages }}" = "true" ]; then
            if ! pnpm --filter @mindware-blog/site lint; then
              echo "âš ï¸  Site linting failed:"
              echo "   - Found ESLint errors or warnings"
              echo "   - Common issues: unused imports, missing dependencies, formatting"
              echo "   - Fix: Run 'pnpm --filter @mindware-blog/site lint --fix' locally"
              echo "   - Tracking: Pre-existing issues being addressed incrementally"
              echo "lint_site_failed=true" >> $GITHUB_OUTPUT
            else
              echo "âœ… Site linting passed"
            fi
          else
            echo "No changes in site/packages; skipping site lint."
          fi
          
          echo ""
          echo "ðŸ” Linting dashboard application..."
          if [ "${{ steps.filter.outputs.dashboard }}" = "true" ] || [ "${{ steps.filter.outputs.packages }}" = "true" ]; then
            if ! pnpm --filter @mindware-blog/dashboard lint; then
              echo "âš ï¸  Dashboard linting failed:"
              echo "   - Found ESLint errors or warnings"
              echo "   - Common issues: TypeScript errors, React hooks dependencies"
              echo "   - Fix: Run 'pnpm --filter @mindware-blog/dashboard lint --fix' locally"
              echo "   - Tracking: Known issues documented in GitHub Issues"
              echo "lint_dashboard_failed=true" >> $GITHUB_OUTPUT
            else
              echo "âœ… Dashboard linting passed"
            fi
          else
            echo "No changes in dashboard/packages; skipping dashboard lint."
          fi
          
          echo ""
          echo "ðŸ“Š Linting Summary:"
          echo "   - Site: $([ -n "${lint_site_failed}" ] && echo 'Failed' || echo 'Passed')"
          echo "   - Dashboard: $([ -n "${lint_dashboard_failed}" ] && echo 'Failed' || echo 'Passed')"

      # Type checking with clear output
      - name: Type check applications
        id: typecheck
        continue-on-error: true
        run: |
          if [ "${{ steps.filter.outputs.site }}" != "true" ] && [ "${{ steps.filter.outputs.dashboard }}" != "true" ] && [ "${{ steps.filter.outputs.packages }}" != "true" ]; then
            echo "No relevant changes detected for typecheck; skipping."
            exit 0
          fi

          echo "ðŸ“ Type checking site application..."
          if [ "${{ steps.filter.outputs.site }}" = "true" ] || [ "${{ steps.filter.outputs.packages }}" = "true" ]; then
            if ! pnpm --filter @mindware-blog/site typecheck 2>&1 | tee site-typecheck.log; then
              echo ""
              echo "âš ï¸  Site type checking failed:"
              echo "   - Found TypeScript compilation errors"
              echo "   - Common issues: Type mismatches, missing type definitions, strict null checks"
              echo "   - Fix: Run 'pnpm --filter @mindware-blog/site typecheck' locally to see details"
              echo "   - Review: Check site-typecheck.log artifact for full error list"
              echo "   - Status: Non-blocking while addressing technical debt"
              echo "   - Tracking: See docs/TECHNICAL_DEBT.md for details and action plan"
              echo "typecheck_site_failed=true" >> $GITHUB_OUTPUT
            else
              echo "âœ… Site type checking passed"
            fi
          else
            echo "No changes in site/packages; skipping site typecheck."
          fi
          
          echo ""
          echo "ðŸ“ Type checking dashboard application..."
          if [ "${{ steps.filter.outputs.dashboard }}" = "true" ] || [ "${{ steps.filter.outputs.packages }}" = "true" ]; then
            if ! pnpm --filter @mindware-blog/dashboard typecheck 2>&1 | tee dashboard-typecheck.log; then
              echo ""
              echo "âš ï¸  Dashboard type checking failed:"
              echo "   - Found TypeScript compilation errors"
              echo "   - Common issues: Missing type definitions, incompatible library types"
              echo "   - Fix: Run 'pnpm --filter @mindware-blog/dashboard typecheck' locally"
              echo "   - Review: Check dashboard-typecheck.log artifact for full error list"
              echo "   - Status: Non-blocking, tracked in backlog for resolution"
              echo "   - Tracking: See docs/TECHNICAL_DEBT.md for details and action plan"
              echo "typecheck_dashboard_failed=true" >> $GITHUB_OUTPUT
            else
              echo "âœ… Dashboard type checking passed"
            fi
          else
            echo "No changes in dashboard/packages; skipping dashboard typecheck."
          fi
          
          echo ""
          echo "ðŸ“Š Type Check Summary:"
          echo "   - Site: $([ -f site-typecheck.log ] && grep -c 'error TS' site-typecheck.log || echo '0') TypeScript errors"
          echo "   - Dashboard: $([ -f dashboard-typecheck.log ] && grep -c 'error TS' dashboard-typecheck.log || echo '0') TypeScript errors"

      # Run unit tests with coverage
      - name: Run unit tests
        id: tests
        continue-on-error: true
        run: |
          if [ "${{ steps.filter.outputs.site }}" != "true" ] && [ "${{ steps.filter.outputs.dashboard }}" != "true" ] && [ "${{ steps.filter.outputs.packages }}" != "true" ]; then
            echo "No relevant changes detected for tests; skipping."
            exit 0
          fi

          echo "ðŸ§ª Running site tests..."
          if [ "${{ steps.filter.outputs.site }}" = "true" ] || [ "${{ steps.filter.outputs.packages }}" = "true" ]; then
            if ! pnpm --filter @mindware-blog/site test -- --ci --passWithNoTests; then
              echo ""
              echo "âš ï¸  Site tests failed or not configured:"
              echo "   - Test suite may be missing or have failing tests"
              echo "   - Action needed: Set up Jest/Vitest configuration"
              echo "   - Add unit tests for critical components and utilities"
              echo "   - Fix: Run 'pnpm --filter @mindware-blog/site test' locally"
              echo "   - Priority: Medium - should be addressed for production readiness"
              echo "test_site_failed=true" >> $GITHUB_OUTPUT
            else
              echo "âœ… Site tests passed"
            fi
          else
            echo "No changes in site/packages; skipping site tests."
          fi
          
          echo ""
          echo "ðŸ§ª Running dashboard tests..."
          if [ "${{ steps.filter.outputs.dashboard }}" = "true" ] || [ "${{ steps.filter.outputs.packages }}" = "true" ]; then
            if ! pnpm --filter @mindware-blog/dashboard test -- --ci --passWithNoTests; then
              echo ""
              echo "âš ï¸  Dashboard tests failed:"
              echo "   - Test suite has failing tests or configuration issues"
              echo "   - Common issues: Mock setup, async timing, component mounting"
              echo "   - Fix: Run 'pnpm --filter @mindware-blog/dashboard test' locally"
              echo "   - Review test failures and update snapshots if needed"
              echo "   - Priority: High - tests should pass before merging new features"
              echo "test_dashboard_failed=true" >> $GITHUB_OUTPUT
            else
              echo "âœ… Dashboard tests passed"
            fi
          else
            echo "No changes in dashboard/packages; skipping dashboard tests."
          fi
          
          echo ""
          echo "ðŸ“Š Test Summary:"
          echo "   - Site: $([ -n "${test_site_failed}" ] && echo 'Failed/Missing' || echo 'Passed')"
          echo "   - Dashboard: $([ -n "${test_dashboard_failed}" ] && echo 'Failed' || echo 'Passed')"

      # Build applications
      - name: Build applications
        id: build
        run: |
          if [ "${{ steps.filter.outputs.site }}" != "true" ] && [ "${{ steps.filter.outputs.dashboard }}" != "true" ] && [ "${{ steps.filter.outputs.packages }}" != "true" ]; then
            echo "No relevant changes detected for build; skipping."
            exit 0
          fi

          echo "ðŸ—ï¸  Building site application..."
          echo "   This is the primary application and must build successfully"
          if [ "${{ steps.filter.outputs.site }}" = "true" ] || [ "${{ steps.filter.outputs.packages }}" = "true" ]; then
            if ! pnpm --filter @mindware-blog/site build; then
              echo ""
              echo "âŒ Site build FAILED - This is a critical error"
              echo "   - The site application failed to compile"
              echo "   - Common issues: TypeScript errors, missing dependencies, build config"
              echo "   - Fix: Run 'pnpm --filter @mindware-blog/site build' locally"
              echo "   - This will block the PR from merging"
              exit 1
            fi
            echo "âœ… Site build completed successfully"
          else
            echo "No changes in site/packages; skipping site build."
          fi
          
          echo ""
          echo "ðŸ—ï¸  Building dashboard application..."
          if [ "${{ steps.filter.outputs.dashboard }}" = "true" ] || [ "${{ steps.filter.outputs.packages }}" = "true" ]; then
            if ! pnpm --filter @mindware-blog/dashboard build; then
              echo ""
              echo "âš ï¸  Dashboard build failed:"
              echo "   - Dashboard application failed to compile"
              echo "   - Common issues: Import errors, missing types, configuration"
              echo "   - Fix: Run 'pnpm --filter @mindware-blog/dashboard build' locally"
              echo "   - Tracking: See docs/TECHNICAL_DEBT.md#dashboard-build-failures"
              echo "   - Status: Non-blocking for site-only deployments"
              echo "   - Note: Dashboard issues should be fixed before v1.2.0 release"
              echo "build_dashboard_failed=true" >> $GITHUB_OUTPUT
            else
              echo "âœ… Dashboard build completed successfully"
            fi
          else
            echo "No changes in dashboard/packages; skipping dashboard build."
          fi
          
          echo ""
          echo "ðŸ“Š Build Summary:"
          echo "   - Site: âœ… Success (required)"
          echo "   - Dashboard: $([ -n "${build_dashboard_failed}" ] && echo 'âš ï¸  Failed (tracked)' || echo 'âœ… Success')"

      # Verify build artifacts with detailed logging
      - name: Verify build artifacts
        run: |
          echo "ðŸ”Ž Verifying build artifacts..."
          echo ""
          
          # Verify site artifacts (critical)
          echo "Checking site build artifacts..."
          if [ "${{ steps.filter.outputs.site }}" != "true" ] && [ "${{ steps.filter.outputs.packages }}" != "true" ]; then
            echo "Skipping site artifact verification (site/packages unchanged)."
          elif [ -d "apps/site/.next" ]; then
            echo "âœ… Site .next directory found"
            SITE_SIZE=$(du -sh apps/site/.next | cut -f1)
            echo "   - Build size: $SITE_SIZE"
            
            # Check for essential files
            if [ -f "apps/site/.next/BUILD_ID" ]; then
              BUILD_ID=$(cat apps/site/.next/BUILD_ID)
              echo "   - Build ID: $BUILD_ID"
            fi
            
            if [ -d "apps/site/.next/server" ]; then
              PAGE_COUNT=$(find apps/site/.next/server/app -name "*.html" 2>/dev/null | wc -l)
              echo "   - Server pages generated: $PAGE_COUNT"
            fi
            
            if [ -d "apps/site/.next/static" ]; then
              echo "   - Static assets: âœ… Present"
            fi
          else
            echo "âŒ CRITICAL: Site build artifacts missing"
            echo "   - Expected directory: apps/site/.next"
            echo "   - This indicates the build step failed silently"
            echo "   - Action: Check build logs above for errors"
            exit 1
          fi
          
          echo ""
          
          # Verify dashboard artifacts (non-critical)
          echo "Checking dashboard build artifacts..."
          if [ "${{ steps.filter.outputs.dashboard }}" != "true" ] && [ "${{ steps.filter.outputs.packages }}" != "true" ]; then
            echo "Skipping dashboard artifact verification (dashboard/packages unchanged)."
          elif [ -d "apps/dashboard/.next" ]; then
            echo "âœ… Dashboard .next directory found"
            DASHBOARD_SIZE=$(du -sh apps/dashboard/.next | cut -f1)
            echo "   - Build size: $DASHBOARD_SIZE"
          else
            echo "âš ï¸  Dashboard build artifacts missing"
            echo "   - This is expected if dashboard build failed earlier"
            echo "   - Status: Non-blocking, tracked in backlog"
            echo "   - Note: Site verification successful, proceeding"
          fi
          
          echo ""
          echo "ðŸ“Š Artifact Verification Complete:"
          echo "   - Site artifacts: âœ… Verified and ready for deployment"
          echo "   - Dashboard artifacts: $([ -d 'apps/dashboard/.next' ] && echo 'âœ… Verified' || echo 'âš ï¸  Missing (known)')"

      # Upload logs as artifacts
      - name: Upload error logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ci-logs
          path: |
            site-typecheck.log
            dashboard-typecheck.log
          if-no-files-found: ignore
      
      # Summary report
      - name: Workflow summary
        if: always()
        run: |
          echo "## ðŸ“Š CI Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Step Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Step | Site | Dashboard | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          
          # Lint status
          LINT_SITE="${{ steps.lint.outputs.lint_site_failed }}"
          LINT_DASHBOARD="${{ steps.lint.outputs.lint_dashboard_failed }}"
          LINT_ICON=$([ -z "$LINT_SITE" ] && [ -z "$LINT_DASHBOARD" ] && echo "âœ…" || echo "âš ï¸")
          echo "| **Lint** | $([ -z "$LINT_SITE" ] && echo 'âœ…' || echo 'âš ï¸') | $([ -z "$LINT_DASHBOARD" ] && echo 'âœ…' || echo 'âš ï¸') | $LINT_ICON Non-blocking |" >> $GITHUB_STEP_SUMMARY
          
          # Type check status
          TC_SITE="${{ steps.typecheck.outputs.typecheck_site_failed }}"
          TC_DASHBOARD="${{ steps.typecheck.outputs.typecheck_dashboard_failed }}"
          TC_ICON=$([ -z "$TC_SITE" ] && [ -z "$TC_DASHBOARD" ] && echo "âœ…" || echo "âš ï¸")
          echo "| **Type Check** | $([ -z "$TC_SITE" ] && echo 'âœ…' || echo 'âš ï¸') | $([ -z "$TC_DASHBOARD" ] && echo 'âœ…' || echo 'âš ï¸') | $TC_ICON Non-blocking |" >> $GITHUB_STEP_SUMMARY
          
          # Test status
          TEST_SITE="${{ steps.tests.outputs.test_site_failed }}"
          TEST_DASHBOARD="${{ steps.tests.outputs.test_dashboard_failed }}"
          TEST_ICON=$([ -z "$TEST_SITE" ] && [ -z "$TEST_DASHBOARD" ] && echo "âœ…" || echo "âš ï¸")
          echo "| **Tests** | $([ -z "$TEST_SITE" ] && echo 'âœ…' || echo 'âš ï¸') | $([ -z "$TEST_DASHBOARD" ] && echo 'âœ…' || echo 'âš ï¸') | $TEST_ICON Non-blocking |" >> $GITHUB_STEP_SUMMARY
          
          # Build status
          BUILD_DASHBOARD="${{ steps.build.outputs.build_dashboard_failed }}"
          BUILD_ICON=$([ -z "$BUILD_DASHBOARD" ] && echo "âœ…" || echo "âš ï¸")
          echo "| **Build** | âœ… | $([ -z "$BUILD_DASHBOARD" ] && echo 'âœ…' || echo 'âš ï¸') | $BUILD_ICON Site required |" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ Notes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **Site build succeeded** - Ready for deployment" >> $GITHUB_STEP_SUMMARY
          
          if [ -n "$LINT_SITE" ] || [ -n "$LINT_DASHBOARD" ]; then
            echo "- âš ï¸  **Linting issues** - Pre-existing, being addressed incrementally" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -n "$TC_SITE" ] || [ -n "$TC_DASHBOARD" ]; then
            echo "- âš ï¸  **Type errors** - Technical debt, non-blocking for deployment" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -n "$TEST_SITE" ] || [ -n "$TEST_DASHBOARD" ]; then
            echo "- âš ï¸  **Test failures** - Should be addressed before next release" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -n "$BUILD_DASHBOARD" ]; then
            echo "- âš ï¸  **Dashboard build failed** - Tracked separately, site-only deployment OK" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”§ Action Items" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. Review workflow logs for specific error details" >> $GITHUB_STEP_SUMMARY
          echo "2. Run failing steps locally to reproduce issues" >> $GITHUB_STEP_SUMMARY
          echo "3. Check uploaded artifacts for detailed error logs" >> $GITHUB_STEP_SUMMARY
          echo "4. Address critical issues before production deployment" >> $GITHUB_STEP_SUMMARY
          echo "5. See [Technical Debt Document](../docs/TECHNICAL_DEBT.md) for detailed tracking" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "_Status: Site is deployment-ready. Dashboard and other issues are tracked in docs/TECHNICAL_DEBT.md and non-blocking._" >> $GITHUB_STEP_SUMMARY

  # Build Storybook component library
  build-storybook:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    # Run in parallel with main build to save time
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Detect changed areas
        id: filter
        uses: dorny/paths-filter@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          filters: |
            site:
              - 'apps/site/**'
            packages:
              - 'packages/**'

      - name: Setup Node + pnpm
        if: steps.filter.outputs.site == 'true' || steps.filter.outputs.packages == 'true'
        uses: ./.github/actions/setup-node-pnpm
        with:
          node-version: "20"
          pnpm-version: "10.14.0"

      - name: Build Storybook
        id: storybook
        continue-on-error: true
        run: |
          echo "ðŸ“š Building Storybook component library..."
          if [ "${{ steps.filter.outputs.site }}" != "true" ] && [ "${{ steps.filter.outputs.packages }}" != "true" ]; then
            echo "No changes in site/packages; skipping Storybook build."
            exit 0
          fi
          if ! pnpm --filter @mindware-blog/site build-storybook; then
            echo ""
            echo "âš ï¸  Storybook build failed:"
            echo "   - Component library documentation failed to build"
            echo "   - This is non-blocking for deployment"
            echo "   - Fix: Run 'pnpm --filter @mindware-blog/site build-storybook' locally"
            echo "   - Priority: Medium - should be addressed for better developer experience"
            exit 1
          fi
          echo "âœ… Storybook build completed successfully"

      - name: Upload Storybook artifact
        if: steps.storybook.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: storybook
          path: apps/site/storybook-static
          retention-days: 7

      - name: Summary
        if: always()
        run: |
          echo "## ðŸ“š Storybook Build" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.storybook.outcome }}" == "success" ]; then
            echo "âœ… **Storybook build successful**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Component library documentation has been built and uploaded as an artifact." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ“¦ Artifact: \`storybook\`" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ“ Retention: 7 days" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ”— Download from the Actions artifacts section" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **Storybook build failed**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The component library documentation failed to build." >> $GITHUB_STEP_SUMMARY
            echo "This is non-blocking, but should be fixed for better developer experience." >> $GITHUB_STEP_SUMMARY
          fi


